!function(s){function e(e){for(var t,n,r=e[0],o=e[1],l=e[2],i=0,a=[];i<r.length;i++)n=r[i],c[n]&&a.push(c[n][0]),c[n]=0;for(t in o)Object.prototype.hasOwnProperty.call(o,t)&&(s[t]=o[t]);for(g&&g(e);a.length;)a.shift()();return d.push.apply(d,l||[]),u()}function u(){for(var e,t=0;t<d.length;t++){for(var n=d[t],r=!0,o=1;o<n.length;o++){var l=n[o];0!==c[l]&&(r=!1)}r&&(d.splice(t--,1),e=i(i.s=n[0]))}return e}var n={},c={5:0},d=[];function i(e){if(n[e])return n[e].exports;var t=n[e]={i:e,l:!1,exports:{}};return s[e].call(t.exports,t,t.exports,i),t.l=!0,t.exports}i.m=s,i.c=n,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="";var t=window.webpackJsonp=window.webpackJsonp||[],r=t.push.bind(t);t.push=e,t=t.slice();for(var o=0;o<t.length;o++)e(t[o]);var g=r;d.push([528,0]),u()}({528:function(e,t,n){n(71),n(72),e.exports=n(617)},529:function(e,t){},530:function(module,exports){module.exports=function(obj){obj||(obj={});var __t,__p="";with(obj)__p+='<div class="gmf-displayquerygrid panel" ng-show="ctrl.active">\n  <div\n    class="close"\n    ng-click="ctrl.clear()">\n    &times;\n  </div>\n\n  <ul\n    class="nav nav-pills"\n    role="tablist">\n\n    <li\n      ng-repeat="gridSource in ctrl.getGridSources() track by gridSource.source.label"\n      role="presentation"\n      ng-class="{\'active\' : ctrl.isSelected(gridSource)}"\n      ng-click="ctrl.selectTab(gridSource)">\n\n      <a\n        href="#{{ctrl.escapeValue(gridSource.source.label)}}"\n        data-target="#{{ctrl.escapeValue(gridSource.source.label)}}"\n        aria-controls="{{ctrl.escapeValue(gridSource.source.label)}}"\n        role="tab"\n        data-toggle="tab">\n\n        <span ng-if="gridSource.source.tooManyResults !== true">\n          {{gridSource.source.label | translate}} ({{gridSource.source.features.length}})\n        </span>\n        <span ng-if="gridSource.source.tooManyResults === true">\n          {{gridSource.source.label | translate}} ({{gridSource.source.totalFeatureCount}}*)\n        </span>\n      </a>\n    </li>\n  </ul>\n\n  <div class="tab-content">\n    <div\n      ng-repeat="gridSource in ctrl.getGridSources() track by gridSource.source.label"\n      role="tabpanel"\n      class="tab-pane"\n      ng-class="{\'active\' : ctrl.isSelected(gridSource)}"\n      id="{{ctrl.escapeValue(gridSource.source.label)}}">\n\n      <ngeo-grid\n        ngeo-grid-configuration="gridSource.configuration"\n        ng-if="gridSource.source.tooManyResults !== true">\n      </ngeo-grid>\n\n      <div ng-if="gridSource.source.tooManyResults === true">\n        <div class="gmf-displayquerygrid-message alert alert-warning">\n          <p><span translate>The results can not be displayed because the maximum number has been reached</span> ({{gridSource.source.limit}}).</p>\n          <p translate>Please refine your query.</p>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div ng-show="!ctrl.pending && ctrl.getActiveGridSource() && ctrl.getActiveGridSource().configuration !== null">\n\n    <ul class="nav justify-content-end">\n\n      <li\n        class="ng-hide"\n        ng-show="ctrl.isOneSelected()">\n        <p class="navbar-text ng-binding">\n          {{ctrl.getSelectedRowCount()}} <span translate>selected element(s)</span>\n        </p>\n      </li>\n\n      <li\n        ng-show="ctrl.isOneSelected()"\n        class="ng-hide">\n        <button\n          class="btn btn-link btn-sm"\n          title="{{\'Zoom to selection\' | translate}}"\n          ng-click="ctrl.zoomToSelection()">\n          <i class="fa fa-search-plus"></i> <span translate>Zoom to</span>\n        </button>\n      </li>\n\n      <li\n        ng-show="ctrl.isOneSelected()"\n        class="ng-hide">\n        <button\n          class="btn btn-link btn-sm"\n          title="{{\'Export selection as CSV\' | translate}}"\n          ng-click="ctrl.downloadCsv()">\n          <i class="fa fa-download"></i> <span translate>Export as CSV</span>\n        </button>\n      </li>\n\n      <li class="navbar-link">\n        <button\n          type="button"\n          class="dropup btn btn-default btn-sm dropdown-toggle"\n          data-toggle="dropdown"\n          aria-haspopup="true"\n          aria-expanded="false">\n          <span translate>Select</span>\n        </button>\n        <ul\n          class="dropdown-menu"\n          aria-labelledby="dLabel">\n          <li>\n            <a\n              href=""\n              ng-click="ctrl.selectAll()" translate>All</a>\n          </li>\n          <li>\n            <a\n              href=""\n              ng-click="ctrl.unselectAll()" translate>None</a>\n          </li>\n          <li>\n            <a\n              href=""\n              ng-click="ctrl.invertSelection()" translate>Reverse selection</a>\n          </li>\n        </ul>\n      </li>\n    </ul>\n  </div>\n\n  <div\n    ng-show="ctrl.pending"\n    class="gmf-displayquerygrid-pending">\n    <span class="fa fa-spinner fa-spin"></span>\n  </div>\n</div>\n';return __p}},617:function(e,t,n){"use strict";n.r(t);n(529);var r=n(180),o=n(107),l=n(54),s=n(1),i=n(105),a=n(214),u=n(208),c=n(356),d=n(228),g=n(106),p=n(145),h=n(19),f=n(3),m=n(34),v=n(65),y=n(31),_=n(30),b=n(10),S=(n(177),angular.module("gmfQueryGridComponent",[i.a.module.name,a.a.module.name,u.a.name,c.a.name,d.a.module.name,g.a.module.name,p.a.module.name]));function C(e,t,n){return n(e,t)}S.value("gmfDisplayquerygridTemplateUrl",function(e,t){var n=t.gmfDisplayquerygridTemplateurl;return void 0!==n?n:"gmf/query/gridComponent"}),S.run(["$templateCache",function(e){e.put("gmf/query/gridComponent",n(530))}]),C.$inject=["$element","$attrs","gmfDisplayquerygridTemplateUrl"],S.component_={controller:"GmfDisplayquerygridController as ctrl",bindings:{active:"=?gmfDisplayquerygridActive",featuresStyleFn:"&gmfDisplayquerygridFeaturesstyle",selectedFeatureStyleFn:"&gmfDisplayquerygridSelectedfeaturestyle",getMapFn:"&gmfDisplayquerygridMap",removeEmptyColumnsFn:"&?gmfDisplayquerygridRemoveemptycolumns",maxResultsFn:"&?gmfDisplayquerygridMaxresults",maxRecenterZoomFn:"&?gmfDisplayquerygridMaxrecenterzoom",mergeTabs:"<?gmfDisplayquerygridMergetabs"},templateUrl:C},S.component("gmfDisplayquerygrid",S.component_),S.Controller_=function(e,t,n,r,o,l,i,a,s){var u=this,c=e.has("ngeoQueryOptions")?e.get("ngeoQueryOptions"):{};this.$scope_=t,this.$timeout_=l,this.ngeoQueryResult=n,this.ngeoMapQuerent_=r,this.ngeoCsvDownload_=i,this.ngeoDataSources_=a,this.$element_=s,this.maxResults=void 0!==c.limit?c.limit:50,this.active=!1,this.pending=!1,this.gridSources={},this.loadedGridSources=[],this.selectedTab=null,this.removeEmptyColumns_=!1,this.maxRecenterZoom,this.mergeTabs={},this.featuresForSources_={},this.features_=new h.b,this.ngeoFeatureOverlayMgr_=o,this.highlightFeatures_=new h.b,this.filename_=e.has("gmfCsvFilename")?e.get("gmfCsvFilename"):"query-results.csv",this.map_=null,this.$scope_.$watchCollection(function(){return n},function(e,t){e!==t&&u.updateData_()}),this.unregisterSelectWatcher_=null},S.Controller_.$inject=["$injector","$scope","ngeoQueryResult","ngeoMapQuerent","ngeoFeatureOverlayMgr","$timeout","ngeoCsvDownload","ngeoDataSources","$element"],S.Controller_.prototype.$onInit=function(){this.removeEmptyColumns_=!!this.removeEmptyColumnsFn&&!0===this.removeEmptyColumnsFn(),this.maxRecenterZoom=this.maxRecenterZoomFn?this.maxRecenterZoomFn():void 0;var e=this.ngeoFeatureOverlayMgr_.getFeatureOverlay();e.setFeatures(this.features_);var t=this.featuresStyleFn();void 0!==t&&(s.a.assertInstanceof(t,b.c),e.setStyle(t));var n=this.ngeoFeatureOverlayMgr_.getFeatureOverlay();n.setFeatures(this.highlightFeatures_);var r=this.selectedFeatureStyleFn();if(void 0!==r)s.a.assertInstanceof(r,b.c);else{var o=new y.a({color:[255,0,0,.6]}),l=new _.a({color:[255,0,0,1],width:2});r=new b.c({fill:o,image:new v.a({fill:o,radius:5,stroke:l}),stroke:l,zIndex:10})}n.setStyle(r);var i=this.getMapFn;if(i){var a=i();s.a.assertInstanceof(a,m.a),this.map_=a}},S.Controller_.prototype.getGridSources=function(){var t=this;return this.loadedGridSources.map(function(e){return t.gridSources[e]})},S.Controller_.prototype.updateData_=function(){var t=this;if(0===this.ngeoQueryResult.total&&!this.hasOneWithTooManyResults_()){var e=this.active;return this.clear(),void(e&&(this.active=this.ngeoQueryResult.pending,this.pending=this.ngeoQueryResult.pending))}this.active=!0,this.pending=!1;var n=this.ngeoQueryResult.sources;0<Object.keys(this.mergeTabs).length&&(n=this.getMergedSources_(n)),n.forEach(function(e){e.tooManyResults?t.makeGrid_(null,e):(e.id=t.escapeValue(e.id),0<e.features.length&&t.collectData_(e))}),0!==this.loadedGridSources.length?null!==this.selectedTab&&""+this.selectedTab in this.gridSources||this.$timeout_(function(){var e=t.loadedGridSources[0];t.selectTab(t.gridSources[e])},0):this.active=!1},S.Controller_.prototype.hasOneWithTooManyResults_=function(){return this.ngeoQueryResult.sources.some(function(e){return e.tooManyResults})},S.Controller_.prototype.escapeValue=function(e){if(Number.isInteger(e))return e;var t=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\ |]/g;return null!==e.match(t)?e.replace(t,"_"):e},S.Controller_.prototype.isSelected=function(e){return this.selectedTab===e.source.label},S.Controller_.prototype.getMergedSources_=function(e){var t=this,n=[],r={};for(var o in e.forEach(function(e){null===t.getMergedSource_(e,r)&&n.push(e)}),r)n.push(r[o]);return n},S.Controller_.prototype.getMergedSource_=function(t,e){var n,r=null;for(var o in this.mergeTabs){if(this.mergeTabs[o].some(function(e){return e==t.label})){r=o;break}}return null===r?null:(r in e?n=e[r]:(n={features:[],id:r,label:r,limit:this.maxResults,pending:!1,queried:!0,tooManyResults:!1,totalFeatureCount:void 0},e[r]=n),t.features.forEach(function(e){n.features.push(e)}),n.tooManyResults=n.tooManyResults||t.tooManyResults,n.tooManyResults&&(n.totalFeatureCount=void 0!==n.totalFeatureCount?n.totalFeatureCount+n.features.length:n.features.length,n.features=[]),void 0!==t.totalFeatureCount&&(n.totalFeatureCount=void 0!==n.totalFeatureCount?n.totalFeatureCount+t.totalFeatureCount:t.totalFeatureCount),n)},S.Controller_.prototype.collectData_=function(e){var t,n,r=e.features,o=[],l=[],i={};(r.forEach(function(e){void 0!==(t=e.getProperties())&&(n=e.getGeometryName(),-1===l.indexOf(n)&&l.push(n),o.push(t),i[d.a.getRowUid(t)]=e)}),this.cleanProperties_(o,l),0<o.length)&&(this.makeGrid_(o,e)&&(this.featuresForSources_[""+e.label]=i))},S.Controller_.prototype.cleanProperties_=function(e,n){e.forEach(function(t){n.forEach(function(e){delete t[e]}),delete t.boundedBy,delete t.ngeo_feature_type_}),!0===this.removeEmptyColumns_&&this.removeEmptyColumnsFn_(e)},S.Controller_.prototype.removeEmptyColumnsFn_=function(e){var t,n,r,o=[];for(n in e[0])for(t=0;t<e.length;t++)if(void 0!==e[t][n]){o.push(n);break}e.forEach(function(t){for(n in r=[],t)-1===o.indexOf(n)&&r.push(n);r.forEach(function(e){delete t[e]})})},S.Controller_.prototype.makeGrid_=function(e,t){var n=""+t.label,r=null;return(null===e||null!==(r=this.getGridConfiguration_(e)))&&(-1==this.loadedGridSources.indexOf(n)&&this.loadedGridSources.push(n),this.gridSources[n]={configuration:r,source:t},!0)},S.Controller_.prototype.getGridConfiguration_=function(e){s.a.assert(0<e.length);var t={};Object.assign(t,e[0]),delete t.ol_uid;var n=this.ngeoDataSources_.collection.getArray().find(function(e){return e.id==t.ngeo_datasource_id});delete t.ngeo_datasource_id;var r=n&&n.columnsOrder.filter(function(e){return e in t})||Object.keys(t),o=[];return r.forEach(function(e){o.push({name:e})}),0<o.length?new d.a(e,o):null},S.Controller_.prototype.clear=function(){this.active=!1,this.pending=!1,this.gridSources={},this.loadedGridSources=[],this.selectedTab=null,this.tooManyResults=!1,this.features_.clear(),this.highlightFeatures_.clear(),this.ngeoMapQuerent_.clear(),this.featuresForSources_={},this.unregisterSelectWatcher_&&this.unregisterSelectWatcher_()},S.Controller_.prototype.selectTab=function(e){var n=this,t=e.source;this.selectedTab=t.label,this.unregisterSelectWatcher_&&(this.unregisterSelectWatcher_(),this.unregisterSelectWatcher_=null),null!==e.configuration&&(this.unregisterSelectWatcher_=this.$scope_.$watchCollection(function(){return e.configuration.selectedRows},function(e,t){Object.keys(e)!==Object.keys(t)&&n.onSelectionChanged_()})),this.updateFeatures_(e),this.reflowGrid_()},S.Controller_.prototype.reflowGrid_=function(){var e=this.escapeValue(this.selectedTab||""),t=this.$element_.find("div.tab-pane#"+e);t.removeClass("active").addClass("active"),this.$timeout_(function(){t.find("div.ngeo-grid-table-container table").trigger("reflow")})},S.Controller_.prototype.onSelectionChanged_=function(){if(null!==this.selectedTab){var e=this.gridSources[""+this.selectedTab];this.updateFeatures_(e)}},S.Controller_.prototype.updateFeatures_=function(e){if(this.features_.clear(),this.highlightFeatures_.clear(),null!==e.configuration){var t=""+e.source.label,n=this.featuresForSources_[t],r=e.configuration.selectedRows;for(var o in n){var l=n[o];o in r?this.highlightFeatures_.push(l):this.features_.push(l)}}},S.Controller_.prototype.getActiveGridSource=function(){return null===this.selectedTab?null:this.gridSources[""+this.selectedTab]},S.Controller_.prototype.isOneSelected=function(){var e=this.getActiveGridSource();return null!==e&&null!==e.configuration&&0<e.configuration.getSelectedCount()},S.Controller_.prototype.getSelectedRowCount=function(){var e=this.getActiveGridSource();return null===e||null===e.configuration?0:e.configuration.getSelectedCount()},S.Controller_.prototype.selectAll=function(){var e=this.getActiveGridSource();null!==e&&e.configuration.selectAll()},S.Controller_.prototype.unselectAll=function(){var e=this.getActiveGridSource();null!==e&&e.configuration.unselectAll()},S.Controller_.prototype.invertSelection=function(){var e=this.getActiveGridSource();null!==e&&e.configuration.invertSelection()},S.Controller_.prototype.zoomToSelection=function(){if(null!==this.getActiveGridSource()){var t=f.j();this.highlightFeatures_.forEach(function(e){f.q(t,e.getGeometry().getExtent())});var e=this.map_.getSize();s.a.assert(void 0!==e);var n=this.maxRecenterZoom;this.map_.getView().fit(t,{size:e,maxZoom:n})}},S.Controller_.prototype.downloadCsv=function(){var e=this.getActiveGridSource();if(null!==e){var t=e.configuration.columnDefs;s.a.assert(void 0!==t);var n=e.configuration.getSelectedRows();this.ngeoCsvDownload_.startDownload(n,t,this.filename_)}},S.controller("GmfDisplayquerygridController",S.Controller_);var w=S,F=n(24),M=n(355),R=n(122),O=n(121),T=n(55),G=n(185),x=n(184),k=n(42),D=n(28),q=n(49),j={};j.module=angular.module("gmfapp",["gettext",r.a.module.name,o.a.name,l.a.name,w.name,F.a.module.name,M.a.name,R.a.name,O.a.name,G.a.name,x.a.name]),j.module.constant("ngeoQueryOptions",{limit:20,queryCountFirst:!0}),j.module.constant("gmfTreeUrl","https://geomapfish-demo-dc.camptocamp.com/2.4/themes?version=2&background=background"),j.module.constant("defaultTheme","Demo"),j.module.constant("angularLocaleScript","../build/angular-locale_{{locale}}.js"),j.queryresultComponent={controller:"gmfappQueryresultController",template:n(395)},j.module.component("gmfappQueryresult",j.queryresultComponent),j.QueryresultController=function(e){this.result=e},j.QueryresultController.$inject=["ngeoQueryResult"],j.module.controller("gmfappQueryresultController",j.QueryresultController),j.MainController=function(e,t,n){var r=this;e.loadThemes();var o=new y.a({color:[255,170,0,.6]}),l=new _.a({color:[255,170,0,1],width:2});this.featureStyle=new b.c({fill:o,image:new v.a({fill:o,radius:5,stroke:l}),stroke:l}),this.map=new m.a({layers:[new D.a({source:new q.a})],view:new k.a({projection:T.a,resolutions:[200,100,50,20,10,5,2.5,2,1,.5],center:[537635,152640],zoom:3})}),t.setDatasourceMap(this.map),this.themes=void 0,this.treeSource=void 0,this.queryActive=!0,this.queryGridActive=!0,e.getThemesObject().then(function(e){e&&(r.themes=e,r.treeSource=e[3])}),n.init(this.map)},j.MainController.$inject=["gmfThemes","gmfDataSourcesManager","ngeoFeatureOverlayMgr"],j.module.controller("MainController",j.MainController);t.default=j}});
//# sourceMappingURL=displayquerygrid.fcaf23.js.map