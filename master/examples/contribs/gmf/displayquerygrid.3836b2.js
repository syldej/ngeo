(function(s){function e(e){var t=e[0];var r=e[1];var n=e[2];var o,a,i=0,l=[];for(;i<t.length;i++){a=t[i];if(c[a]){l.push(c[a][0])}c[a]=0}for(o in r){if(Object.prototype.hasOwnProperty.call(r,o)){s[o]=r[o]}}if(d)d(e);while(l.length){l.shift()()}f.push.apply(f,n||[]);return u()}function u(){var e;for(var t=0;t<f.length;t++){var r=f[t];var n=true;for(var o=1;o<r.length;o++){var a=r[o];if(c[a]!==0)n=false}if(n){f.splice(t--,1);e=i(i.s=r[0])}}return e}var r={};var c={5:0};var f=[];function i(e){if(r[e]){return r[e].exports}var t=r[e]={i:e,l:false,exports:{}};s[e].call(t.exports,t,t.exports,i);t.l=true;return t.exports}i.m=s;i.c=r;i.d=function(e,t,r){if(!i.o(e,t)){Object.defineProperty(e,t,{enumerable:true,get:r})}};i.r=function(e){if(typeof Symbol!=="undefined"&&Symbol.toStringTag){Object.defineProperty(e,Symbol.toStringTag,{value:"Module"})}Object.defineProperty(e,"__esModule",{value:true})};i.t=function(t,e){if(e&1)t=i(t);if(e&8)return t;if(e&4&&typeof t==="object"&&t&&t.__esModule)return t;var r=Object.create(null);i.r(r);Object.defineProperty(r,"default",{enumerable:true,value:t});if(e&2&&typeof t!="string")for(var n in t)i.d(r,n,function(e){return t[e]}.bind(null,n));return r};i.n=function(t){var e=t&&t.__esModule?function e(){return t["default"]}:function e(){return t};i.d(e,"a",e);return e};i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)};i.p="";var t=window["webpackJsonp"]=window["webpackJsonp"]||[];var n=t.push.bind(t);t.push=e;t=t.slice();for(var o=0;o<t.length;o++)e(t[o]);var d=n;f.push([530,0]);return u()})({530:function(e,t,r){r(72);r(73);e.exports=r(619)},531:function(e,t){},532:function(module,exports){module.exports=function(obj){obj||(obj={});var __t,__p="";with(obj){__p+='<div class="gmf-displayquerygrid panel" ng-show="ctrl.active">\n  <div\n    class="close"\n    ng-click="ctrl.clear()">\n    &times;\n  </div>\n\n  <ul\n    class="nav nav-pills"\n    role="tablist">\n\n    <li\n      ng-repeat="gridSource in ctrl.getGridSources() track by gridSource.source.label"\n      role="presentation"\n      ng-class="{\'active\' : ctrl.isSelected(gridSource)}"\n      ng-click="ctrl.selectTab(gridSource)">\n\n      <a\n        href="#{{ctrl.escapeValue(gridSource.source.label)}}"\n        data-target="#{{ctrl.escapeValue(gridSource.source.label)}}"\n        aria-controls="{{ctrl.escapeValue(gridSource.source.label)}}"\n        role="tab"\n        data-toggle="tab">\n\n        <span ng-if="gridSource.source.tooManyResults !== true">\n          {{gridSource.source.label | translate}} ({{gridSource.source.features.length}})\n        </span>\n        <span ng-if="gridSource.source.tooManyResults === true">\n          {{gridSource.source.label | translate}} ({{gridSource.source.totalFeatureCount}}*)\n        </span>\n      </a>\n    </li>\n  </ul>\n\n  <div class="tab-content">\n    <div\n      ng-repeat="gridSource in ctrl.getGridSources() track by gridSource.source.label"\n      role="tabpanel"\n      class="tab-pane"\n      ng-class="{\'active\' : ctrl.isSelected(gridSource)}"\n      id="{{ctrl.escapeValue(gridSource.source.label)}}">\n\n      <ngeo-grid\n        ngeo-grid-configuration="gridSource.configuration"\n        ng-if="gridSource.source.tooManyResults !== true">\n      </ngeo-grid>\n\n      <div ng-if="gridSource.source.tooManyResults === true">\n        <div class="gmf-displayquerygrid-message alert alert-warning">\n          <p><span translate>The results can not be displayed because the maximum number has been reached</span> ({{gridSource.source.limit}}).</p>\n          <p translate>Please refine your query.</p>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <div ng-show="!ctrl.pending && ctrl.getActiveGridSource() && ctrl.getActiveGridSource().configuration !== null">\n\n    <ul class="nav justify-content-end">\n\n      <li\n        class="ng-hide"\n        ng-show="ctrl.isOneSelected()">\n        <p class="navbar-text ng-binding">\n          {{ctrl.getSelectedRowCount()}} <span translate>selected element(s)</span>\n        </p>\n      </li>\n\n      <li\n        ng-show="ctrl.isOneSelected()"\n        class="ng-hide">\n        <button\n          class="btn btn-link btn-sm"\n          title="{{\'Zoom to selection\' | translate}}"\n          ng-click="ctrl.zoomToSelection()">\n          <i class="fa fa-search-plus"></i> <span translate>Zoom to</span>\n        </button>\n      </li>\n\n      <li\n        ng-show="ctrl.isOneSelected()"\n        class="ng-hide">\n        <button\n          class="btn btn-link btn-sm"\n          title="{{\'Export selection as CSV\' | translate}}"\n          ng-click="ctrl.downloadCsv()">\n          <i class="fa fa-download"></i> <span translate>Export as CSV</span>\n        </button>\n      </li>\n\n      <li class="navbar-link">\n        <button\n          type="button"\n          class="dropup btn btn-default btn-sm dropdown-toggle"\n          data-toggle="dropdown"\n          aria-haspopup="true"\n          aria-expanded="false">\n          <span translate>Select</span>\n        </button>\n        <ul\n          class="dropdown-menu"\n          aria-labelledby="dLabel">\n          <li>\n            <a\n              href=""\n              ng-click="ctrl.selectAll()" translate>All</a>\n          </li>\n          <li>\n            <a\n              href=""\n              ng-click="ctrl.unselectAll()" translate>None</a>\n          </li>\n          <li>\n            <a\n              href=""\n              ng-click="ctrl.invertSelection()" translate>Reverse selection</a>\n          </li>\n        </ul>\n      </li>\n    </ul>\n  </div>\n\n  <div\n    ng-show="ctrl.pending"\n    class="gmf-displayquerygrid-pending">\n    <span class="fa fa-spinner fa-spin"></span>\n  </div>\n</div>\n'}return __p}},619:function(e,t,r){"use strict";r.r(t);var n=r(32);var o=r(531);var a=r(182);var i=r(106);var l=r(55);var s=r(1);var u=r(215);var c=r(209);var f=r(357);var d=r(229);var g=r(105);var p=r(144);var h=r(23);var v=r(3);var m=r(34);var y=r(66);var _=r(30);var b=r(29);var S=r(11);var C=r(177);var w=angular.module("gmfQueryGridComponent",[u["a"].module.name,c["a"].name,f["a"].name,d["a"].module.name,g["a"].module.name,p["a"].module.name]);w.value("gmfDisplayquerygridTemplateUrl",function(e,t){var r=t["gmfDisplayquerygridTemplateurl"];return r!==undefined?r:"gmf/query/gridComponent"});w.run(["$templateCache",function(e){e.put("gmf/query/gridComponent",r(532))}]);F.$inject=["$element","$attrs","gmfDisplayquerygridTemplateUrl"];function F(e,t,r){return r(e,t)}w.component_={controller:"GmfDisplayquerygridController as ctrl",bindings:{active:"=?gmfDisplayquerygridActive",featuresStyleFn:"&gmfDisplayquerygridFeaturesstyle",selectedFeatureStyleFn:"&gmfDisplayquerygridSelectedfeaturestyle",getMapFn:"&gmfDisplayquerygridMap",removeEmptyColumnsFn:"&?gmfDisplayquerygridRemoveemptycolumns",maxResultsFn:"&?gmfDisplayquerygridMaxresults",maxRecenterZoomFn:"&?gmfDisplayquerygridMaxrecenterzoom",mergeTabs:"<?gmfDisplayquerygridMergetabs"},templateUrl:F};w.component("gmfDisplayquerygrid",w.component_);w.Controller_=function(e,t,r,n,o,a,i,l){var s=this;var u=e.has("ngeoQueryOptions")?e.get("ngeoQueryOptions"):{};this.$scope_=t;this.$timeout_=a;this.ngeoQueryResult=r;this.ngeoMapQuerent_=n;this.ngeoCsvDownload_=i;this.$element_=l;this.maxResults=u.limit!==undefined?u.limit:50;this.active=false;this.pending=false;this.gridSources={};this.loadedGridSources=[];this.selectedTab=null;this.removeEmptyColumns_=false;this.maxRecenterZoom;this.mergeTabs={};this.featuresForSources_={};this.features_=new h["a"];this.ngeoFeatureOverlayMgr_=o;this.highlightFeatures_=new h["a"];this.filename_=e.has("gmfCsvFilename")?e.get("gmfCsvFilename"):"query-results.csv";this.map_=null;this.$scope_.$watchCollection(function(){return r},function(e,t){if(e!==t){s.updateData_()}});this.unregisterSelectWatcher_=null};w.Controller_.$inject=["$injector","$scope","ngeoQueryResult","ngeoMapQuerent","ngeoFeatureOverlayMgr","$timeout","ngeoCsvDownload","$element"];w.Controller_.prototype.$onInit=function(){this.removeEmptyColumns_=this["removeEmptyColumnsFn"]?this["removeEmptyColumnsFn"]()===true:false;this.maxRecenterZoom=this["maxRecenterZoomFn"]?this["maxRecenterZoomFn"]():undefined;var e=this.ngeoFeatureOverlayMgr_.getFeatureOverlay();e.setFeatures(this.features_);var t=this["featuresStyleFn"]();if(t!==undefined){s["a"].assertInstanceof(t,S["c"]);e.setStyle(t)}var r=this.ngeoFeatureOverlayMgr_.getFeatureOverlay();r.setFeatures(this.highlightFeatures_);var n=this["selectedFeatureStyleFn"]();if(n!==undefined){s["a"].assertInstanceof(n,S["c"])}else{var o=new _["a"]({color:[255,0,0,.6]});var a=new b["a"]({color:[255,0,0,1],width:2});n=new S["c"]({fill:o,image:new y["a"]({fill:o,radius:5,stroke:a}),stroke:a,zIndex:10})}r.setStyle(n);var i=this["getMapFn"];if(i){var l=i();s["a"].assertInstanceof(l,m["a"]);this.map_=l}};w.Controller_.prototype.getGridSources=function(){var t=this;return this.loadedGridSources.map(function(e){return t.gridSources[e]})};w.Controller_.prototype.updateData_=function(){var r=this;if(this.ngeoQueryResult.total===0&&!this.hasOneWithTooManyResults_()){var e=this.active;this.clear();if(e){this.active=this.ngeoQueryResult.pending;this.pending=this.ngeoQueryResult.pending}return}this.active=true;this.pending=false;var t=this.ngeoQueryResult.sources;if(Object.keys(this.mergeTabs).length>0){t=this.getMergedSources_(t)}t.forEach(function(e){if(e.tooManyResults){r.makeGrid_(null,e)}else{e.id=r.escapeValue(e.id);var t=e.features;if(t.length>0){r.collectData_(e)}}});if(this.loadedGridSources.length===0){this.active=false;return}if(this.selectedTab===null||!(""+this.selectedTab in this.gridSources)){this.$timeout_(function(){var e=r.loadedGridSources[0];r.selectTab(r.gridSources[e])},0)}};w.Controller_.prototype.hasOneWithTooManyResults_=function(){return this.ngeoQueryResult.sources.some(function(e){return e.tooManyResults})};w.Controller_.prototype.escapeValue=function(e){if(Number.isInteger(e)){return e}else{var t=/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\ |]/g;if(e.match(t)!==null){return e.replace(t,"_")}else{return e}}};w.Controller_.prototype.isSelected=function(e){return this.selectedTab===e.source.label};w.Controller_.prototype.getMergedSources_=function(e){var r=this;var n=[];var o={};e.forEach(function(e){var t=r.getMergedSource_(e,o);if(t===null){n.push(e)}});for(var t in o){n.push(o[t])}return n};w.Controller_.prototype.getMergedSource_=function(t,e){var r=null;for(var n in this.mergeTabs){var o=this.mergeTabs[n];var a=o.some(function(e){return e==t.label});if(a){r=n;break}}if(r===null){return null}var i;if(r in e){i=e[r]}else{i={features:[],id:r,label:r,limit:this.maxResults,pending:false,queried:true,tooManyResults:false,totalFeatureCount:undefined};e[r]=i}t.features.forEach(function(e){i.features.push(e)});i.tooManyResults=i.tooManyResults||t.tooManyResults;if(i.tooManyResults){i.totalFeatureCount=i.totalFeatureCount!==undefined?i.totalFeatureCount+i.features.length:i.features.length;i.features=[]}if(t.totalFeatureCount!==undefined){i.totalFeatureCount=i.totalFeatureCount!==undefined?i.totalFeatureCount+t.totalFeatureCount:t.totalFeatureCount}return i};w.Controller_.prototype.collectData_=function(e){var t=e.features;var r=[];var n=[];var o={};var a,i;t.forEach(function(e){a=e.getProperties();if(a!==undefined){i=e.getGeometryName();if(n.indexOf(i)===-1){n.push(i)}r.push(a);o[d["a"].getRowUid(a)]=e}});this.cleanProperties_(r,n);if(r.length>0){var l=this.makeGrid_(r,e);if(l){this.featuresForSources_[""+e.label]=o}}};w.Controller_.prototype.cleanProperties_=function(e,r){e.forEach(function(t){r.forEach(function(e){delete t[e]});delete t["boundedBy"];delete t["ngeo_feature_type_"]});if(this.removeEmptyColumns_===true){this.removeEmptyColumnsFn_(e)}};w.Controller_.prototype.removeEmptyColumnsFn_=function(e){var r=[];var t,n;for(n in e[0]){for(t=0;t<e.length;t++){if(e[t][n]!==undefined){r.push(n);break}}}var o;e.forEach(function(t){o=[];for(n in t){if(r.indexOf(n)===-1){o.push(n)}}o.forEach(function(e){delete t[e]})})};w.Controller_.prototype.makeGrid_=function(e,t){var r=""+t.label;var n=null;if(e!==null){n=this.getGridConfiguration_(e);if(n===null){return false}}if(this.loadedGridSources.indexOf(r)==-1){this.loadedGridSources.push(r)}this.gridSources[r]={configuration:n,source:t};return true};w.Controller_.prototype.getGridConfiguration_=function(e){s["a"].assert(e.length>0);var t={};Object.assign(t,e[0]);delete t.ol_uid;var r=Object.keys(t);var n=[];r.forEach(function(e){n.push({name:e})});if(n.length>0){return new d["a"](e,n)}else{return null}};w.Controller_.prototype.clear=function(){this.active=false;this.pending=false;this.gridSources={};this.loadedGridSources=[];this.selectedTab=null;this.tooManyResults=false;this.features_.clear();this.highlightFeatures_.clear();this.ngeoMapQuerent_.clear();this.featuresForSources_={};if(this.unregisterSelectWatcher_){this.unregisterSelectWatcher_()}};w.Controller_.prototype.selectTab=function(e){var r=this;var t=e.source;this.selectedTab=t.label;if(this.unregisterSelectWatcher_){this.unregisterSelectWatcher_();this.unregisterSelectWatcher_=null}if(e.configuration!==null){this.unregisterSelectWatcher_=this.$scope_.$watchCollection(function(){return e.configuration.selectedRows},function(e,t){if(Object.keys(e)!==Object.keys(t)){r.onSelectionChanged_()}})}this.updateFeatures_(e);this.reflowGrid_()};w.Controller_.prototype.reflowGrid_=function(){var e=this.escapeValue(this.selectedTab||"");var t=this.$element_.find("div.tab-pane#"+e);t.removeClass("active").addClass("active");this.$timeout_(function(){t.find("div.ngeo-grid-table-container table")["trigger"]("reflow")})};w.Controller_.prototype.onSelectionChanged_=function(){if(this.selectedTab===null){return}var e=this.gridSources[""+this.selectedTab];this.updateFeatures_(e)};w.Controller_.prototype.updateFeatures_=function(e){this.features_.clear();this.highlightFeatures_.clear();if(e.configuration===null){return}var t=""+e.source.label;var r=this.featuresForSources_[t];var n=e.configuration.selectedRows;for(var o in r){var a=r[o];if(o in n){this.highlightFeatures_.push(a)}else{this.features_.push(a)}}};w.Controller_.prototype.getActiveGridSource=function(){if(this.selectedTab===null){return null}else{return this.gridSources[""+this.selectedTab]}};w.Controller_.prototype.isOneSelected=function(){var e=this.getActiveGridSource();if(e===null||e.configuration===null){return false}else{return e.configuration.getSelectedCount()>0}};w.Controller_.prototype.getSelectedRowCount=function(){var e=this.getActiveGridSource();if(e===null||e.configuration===null){return 0}else{return e.configuration.getSelectedCount()}};w.Controller_.prototype.selectAll=function(){var e=this.getActiveGridSource();if(e!==null){e.configuration.selectAll()}};w.Controller_.prototype.unselectAll=function(){var e=this.getActiveGridSource();if(e!==null){e.configuration.unselectAll()}};w.Controller_.prototype.invertSelection=function(){var e=this.getActiveGridSource();if(e!==null){e.configuration.invertSelection()}};w.Controller_.prototype.zoomToSelection=function(){var e=this.getActiveGridSource();if(e!==null){var t=v["j"]();this.highlightFeatures_.forEach(function(e){v["q"](t,e.getGeometry().getExtent())});var r=this.map_.getSize();s["a"].assert(r!==undefined);var n=this.maxRecenterZoom;this.map_.getView().fit(t,{size:r,maxZoom:n})}};w.Controller_.prototype.downloadCsv=function(){var e=this.getActiveGridSource();if(e!==null){var t=e.configuration.columnDefs;s["a"].assert(t!==undefined);var r=e.configuration.getSelectedRows();this.ngeoCsvDownload_.startDownload(r,t,this.filename_)}};w.controller("GmfDisplayquerygridController",w.Controller_);var M=w;var R=r(22);var T=r(356);var G=r(121);var O=r(120);var x=r(56);var q=r(187);var j=r(186);var k=r(43);var D=r(28);var E=r(49);var $={};$.module=angular.module("gmfapp",["gettext",a["a"].module.name,i["a"].name,l["a"].name,M.name,R["a"].module.name,T["a"].name,G["a"].name,O["a"].name,q["a"].name,j["a"].name]);$.module.constant("ngeoQueryOptions",{limit:20,queryCountFirst:true});$.module.constant("gmfTreeUrl",n["a"].GMF_THEMES);$.module.constant("defaultTheme","Demo");$.module.constant("angularLocaleScript","../build/angular-locale_{{locale}}.js");$.queryresultComponent={controller:"gmfappQueryresultController",template:r(396)};$.module.component("gmfappQueryresult",$.queryresultComponent);$.QueryresultController=function(e){this.result=e};$.QueryresultController.$inject=["ngeoQueryResult"];$.module.controller("gmfappQueryresultController",$.QueryresultController);$.MainController=function(e,t,r){var n=this;e.loadThemes();var o=new _["a"]({color:[255,170,0,.6]});var a=new b["a"]({color:[255,170,0,1],width:2});this.featureStyle=new S["c"]({fill:o,image:new y["a"]({fill:o,radius:5,stroke:a}),stroke:a});this.map=new m["a"]({layers:[new D["a"]({source:new E["a"]})],view:new k["a"]({projection:x["a"],resolutions:[200,100,50,20,10,5,2.5,2,1,.5],center:[537635,152640],zoom:3})});t.setDatasourceMap(this.map);this.themes=undefined;this.treeSource=undefined;this.queryActive=true;this.queryGridActive=true;e.getThemesObject().then(function(e){if(e){n.themes=e;n.treeSource=e[3]}});r.init(this.map)};$.MainController.$inject=["gmfThemes","gmfDataSourcesManager","ngeoFeatureOverlayMgr"];$.module.controller("MainController",$.MainController);var Q=t["default"]=$}});
//# sourceMappingURL=displayquerygrid.3836b2.js.map